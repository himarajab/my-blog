{% extends 'blog/base.html'%}
{% load crispy_forms_tags %}
{% block title %}
    {{ post.title_tag }}
{% endblock title %}

{% block content%}

<!--current user : {{user.id}}-->
<!--post author : {{post.author.id}}-->
<h1>{{ post.title }} </h1>

    By {{post.author}}
<!--    {{post.author.last_name}}-->
    {{post.post_date|date:'d-m-Y'}}

    {% if user.is_authenticated %}
    {% if user.id == post.author.id%}
    -
    <a href="{% url 'update-post' post.pk %}"> Update Post</a>
    <a href="{% url 'delete-post' post.pk %}"> Delete Post</a>
    {% endif %}

<hr>
<br /><br />
<a href="{% url 'home'%}" class="btn btn-secondary">back </a>

<br /><br />
<hr>





<div class="border p-3 mb-3">
    <img class="img-fluid rounded-circle border m-2" style="width: 70px; height:70px;"
        src="{{post.author.profile.image.url}}" alt="صورة الناشر">
    <span class="text-secondary">Postd In {{post.post_date|date:'d-m-Y'}}</span>
    <!-- Button of editing -->
    {% if post.author == user %}
    <div class="form-group btn-editing">
        <a class="btn btn-secondary" href="{% url 'update-post' post.id %}">Edit</a>
        <a class="btn btn-danger" href="{% url 'delete-post' post.id %}">Delete</a>
    </div>
    {% endif %}
    {% endif %}
    <h3>{{post.title}}</h3>
    <p>{{post.content}}</p>
</div>


<p> <a class="like-btn" data-href="{{post.get_api_like_url}}" href="{{post.get_like_url}}" data-likes = "{{total_likes}}">
    Likes : {{total_likes}} Like
</a></p>



<script>
    $(document).ready(function(){
        function updateText(btn,newCount,verb){
            btn.text(newCount + " " + verb)
        }
        $(".like-btn").click(function(e){
            e.preventDefault()
            var this_ = $(this)
            var likeUrl = this_.attr("data-href")
            //convert string to integer
            var likeCount =parseInt(this_.attr("data-likes")) | 0
            var addLike = likeCount +1
            var removeLike = likeCount -1

            $.ajax({
                url : likeUrl,
                method : "GET",
                data : {},
                success : function(data){
                    console.log(data)
                    var newLikes;
                    if (data.liked){
                        //add one
                         newLikes = likeCount +1
                         updateText(this_ ,addLike,"like" )
                    }
                    else{
                        //remove one

                         newLikes = likeCount -1
                         updateText(this_ ,removeLike,"like" )
                        
                    
                    }
                },
                error: function(error){
                    console.log(error,'error')
                }
            })
        })
    })
</script>



<!-- Display Comments -->
<h2 class="border-bottom mt-5 mb-3"> Comments  ({{comments.count}})</h2>
{% for comment in comments %}
<ul class="p-3 comment">
    <h6 class="border-bottom p-2">( {{comment.name}} ) <span
            class="text-secondary">{{comment.comment_date|date:'d-m-Y'}}</span></h6>
    {{comment.body}}
</ul>
{% empty %}
<h6 class="text-center p-4 mb-3 comment"> there's no comments </h6>
{% endfor %}

<!-- Comment Form -->
<h3 class="border-bottom pb-3 mb-3 mt-5"> Add New Comment </h3>

<div class="border p-4 mb-5 mt-4">
    <form method="POST">
        {% csrf_token %}
        {{comment_form|crispy}}
        <input class="btn btn-secondary" type="submit" value="Comment">
    </form>
</div>

{% endblock content%}